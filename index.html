<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Candy Crush Clone</title>
<style>
  body{margin:0;background:#222;font-family:sans-serif;color:#fff;display:flex;flex-direction:column;align-items:center}
  h1{margin:10px}
  #hud{display:flex;gap:20px;font-size:18px;margin:10px}
  #board{display:grid;grid-template-columns:repeat(9,55px);grid-template-rows:repeat(9,55px);gap:3px;margin-top:10px}
  .cell{width:55px;height:55px;border-radius:12px;cursor:pointer;box-shadow:0 0 6px #000;transition:transform 0.2s}
  .c0{background:#e63946}
  .c1{background:#f1c40f}
  .c2{background:#2ecc71}
  .c3{background:#3498db}
  .c4{background:#9b59b6}
  .c5{background:#ff7f50}
  #popup{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:10}
  #popup div{background:#fff;color:#000;padding:20px;border-radius:10px;text-align:center}
  button{padding:10px 20px;font-size:16px;border:none;border-radius:8px;background:#3498db;color:#fff;cursor:pointer}
</style>
</head>
<body>
<h1>Candy Crush Clone</h1>
<div id="hud">
  <div id="stage">Stage: 1</div>
  <div id="score">Score: 0</div>
  <div id="moves">Moves: 20</div>
</div>
<div id="board"></div>
<div id="popup"><div>
  <h2 id="popupMsg">You Win!</h2>
  <button onclick="nextStage()">Next Stage</button>
</div></div>

<script>
const rows=9, cols=9, types=6;
let board=[], score=0, stage=1, target=500, moves=20;
const boardEl=document.getElementById("board");
const scoreEl=document.getElementById("score");
const stageEl=document.getElementById("stage");
const movesEl=document.getElementById("moves");
const popup=document.getElementById("popup");
const popupMsg=document.getElementById("popupMsg");

// sounds
const sndSwap=new Audio("https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg");
const sndMatch=new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");
const sndWin=new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
const sndLose=new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

function init(){
  score=0; moves=20;
  board=[];
  for(let r=0;r<rows;r++){
    board[r]=[];
    for(let c=0;c<cols;c++){
      do{ board[r][c]=rand(); }while(hasMatchAt(r,c));
    }
  }
  render();
}

function rand(){ return Math.floor(Math.random()*types); }
function hasMatchAt(r,c){
  let v=board[r][c];
  return (c>=2 && board[r][c-1]===v && board[r][c-2]===v) ||
         (r>=2 && board[r-1][c]===v && board[r-2][c]===v);
}

function render(){
  boardEl.innerHTML="";
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      let d=document.createElement("div");
      d.className="cell c"+board[r][c];
      d.dataset.r=r; d.dataset.c=c;
      enableDrag(d);
      boardEl.appendChild(d);
    }
  }
  scoreEl.textContent="Score: "+score+" / "+target;
  stageEl.textContent="Stage: "+stage;
  movesEl.textContent="Moves: "+moves;
}

let selected=null;
function cellClick(r,c,el){
  if(!selected){ selected={r,c,el}; el.style.outline="3px solid #fff"; return; }
  let r2=selected.r,c2=selected.c;
  selected.el.style.outline="";
  if(Math.abs(r-r2)+Math.abs(c-c2)===1){
    swap(r,c,r2,c2); sndSwap.play(); moves--;
    if(checkMatches().length>0) resolve(); else swap(r,c,r2,c2);
  }
  selected=null; render(); checkGame();
}

// drag drop
function enableDrag(el){
  el.draggable=true;
  el.ondragstart=e=>{selected={r:parseInt(el.dataset.r),c:parseInt(el.dataset.c),el};};
  el.ondragover=e=>e.preventDefault();
  el.ondrop=e=>{
    let r=parseInt(el.dataset.r),c=parseInt(el.dataset.c);
    let r2=selected.r,c2=selected.c;
    if(Math.abs(r-r2)+Math.abs(c-c2)===1){
      swap(r,c,r2,c2); sndSwap.play(); moves--;
      if(checkMatches().length>0) resolve(); else swap(r,c,r2,c2);
    }
    selected=null; render(); checkGame();
  };
  el.onclick=()=>cellClick(parseInt(el.dataset.r),parseInt(el.dataset.c),el);
}

function swap(r1,c1,r2,c2){ let t=board[r1][c1]; board[r1][c1]=board[r2][c2]; board[r2][c2]=t; }

function checkMatches(){
  let matches=[];
  for(let r=0;r<rows;r++){
    let run=1;
    for(let c=1;c<=cols;c++){
      if(c<cols && board[r][c]===board[r][c-1]) run++;
      else{ if(run>=3) for(let k=0;k<run;k++) matches.push({r,c:c-1-k}); run=1; }
    }
  }
  for(let c=0;c<cols;c++){
    let run=1;
    for(let r=1;r<=rows;r++){
      if(r<rows && board[r][c]===board[r-1][c]) run++;
      else{ if(run>=3) for(let k=0;k<run;k++) matches.push({r:r-1-k,c}); run=1; }
    }
  }
  return matches;
}

function resolve(){
  let matches=checkMatches();
  if(matches.length===0){ checkGame(); return; }
  matches.forEach(m=>{ board[m.r][m.c]=null; score+=10; });
  sndMatch.play();
  // collapse
  for(let c=0;c<cols;c++){
    let arr=[];
    for(let r=rows-1;r>=0;r--) if(board[r][c]!=null) arr.push(board[r][c]);
    for(let r=rows-1;r>=0;r--){
      board[r][c]=arr.shift() ?? rand();
    }
  }
  render();
  setTimeout(resolve,200);
}

function checkGame(){
  if(score>=target){ win(); }
  else if(moves<=0){ lose(); }
}

function win(){
  sndWin.play();
  popupMsg.textContent="Stage "+stage+" Complete!";
  popup.style.display="flex";
}
function lose(){
  sndLose.play();
  popupMsg.textContent="Game Over! Score: "+score;
  popup.style.display="flex";
  document.querySelector("#popup button").textContent="Restart";
}
function nextStage(){
  if(score>=target){ stage++; target+=300; }
  popup.style.display="none";
  init();
}
init();
</script>
</body>
</html>
